import bs4
import requests
import vk_api
from vk_api.longpoll import VkLongPoll, VkEventType
from zodiacusBrains import VkBot

# API —Ç–æ–∫–µ–Ω —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
mytoken = 'b8bfa52f5f8b7f2f5d9c787032a5d4b9aac5f9f06e82b3b736ce3a5315cb6bcccb1a725805a2ec024147c'

# –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –∫–∞–∫ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
vk = vk_api.VkApi(token=mytoken)
longpoll = VkLongPoll(vk)


def write_msg(user_id, message):
    """–§—É–Ω–∫—Ü–∏—è, –ø–æ—Å—ã–ª–∞—é—â–∞—è —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    random_id = vk_api.utils.get_random_id()
    keyboard = open("keyboard.json", "r", encoding="UTF-8").read()
    # –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä–æ–π
    vk.method('messages.send', {'user_id': user_id, 'message': message, 'random_id': random_id, 'keyboard': keyboard})


def switch_sings(argument):
    """
    –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞ –∏ –ø–µ—Ä–µ–≤–æ–¥–∞ –µ–≥–æ —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –≤ –∞–≥–ª–∏–π—Å–∫–∏–π
    —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç
    :param argument –≤–≤–µ–¥—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞
    :return –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –∏–ª–∏ –∫–æ–¥ –æ—à–∏–±–∫–∏ -1
    """
    return {
        "–æ–≤–µ–Ω": "aries",
        "—Ç–µ–ª–µ—Ü": "taurus",
        "–±–ª–∏–∑–Ω–µ—Ü—ã": "gemini",
        "—Ä–∞–∫": "cancer",
        "–ª–µ–≤": "leo",
        "–¥–µ–≤–∞": "virgo",
        "–≤–µ—Å—ã": "libra",
        "—Å–∫–æ—Ä–ø–∏–æ–Ω": "scorpio",
        "—Å—Ç—Ä–µ–ª–µ—Ü": "sagittarius",
        "–∫–æ–∑–µ—Ä–æ–≥": "capricorn",
        "–≤–æ–¥–æ–ª–µ–π": "aquarius",
        "—Ä—ã–±—ã": "pisces",
    }.get(argument, -1)


def _get_personal_horoscope(sign, text):
    """
    –§—É–Ω–∫—Ü–∏—è –≤—ã–≤–æ–¥–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –≥–æ—Ä–æ—Å–∫–æ–ø–∞
    :param sign –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞
    :param text —Ä—É—Å—Å–∫–æ–µ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –≤–≤–µ–¥—ë–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞
    :return —Ç–µ–∫—Å—Ç –≥–æ—Ä–æ—Å–∫–æ–ø–∞
    """
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –≥–æ—Ä–æ—Å–∫–æ–ø–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
    request = requests.get("https://horo.mail.ru/prediction/" + sign + "/today/")
    # –ø–∞—Ä—Å–∏–º
    soup = bs4.BeautifulSoup(request.text, "html.parser")
    horoscope_txt = soup.find('div', 'article__item article__item_alignment_left article__item_html').getText()
    return "–í–æ—Ç —á—Ç–æ –∑–≤—ë–∑–¥—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª–∏ –¥–ª—è –∑–Ω–∞–∫–∞ " + text.lower() + "üëÄ:\n" + horoscope_txt


# –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –≥–æ—Ä–æ—Å–∫–æ–ø–∞:
def _get_horoscope_for_all(day):
    """
    –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥–æ—Ä–æ—Å–∫–æ–ø–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–Ω—è –Ω–µ–¥–µ–ª–∏
    :param day –≤–≤–µ–¥—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –¥–µ–Ω—å, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –Ω—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å –≥–æ—Ä–æ—Å–∫–æ–ø
    :return —Ç–µ–∫—Å—Ç –≥–æ—Ä–æ—Å–∫–æ–ø–∞
    """
    # –ü–æ—Å—ã–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –≥–æ—Ä–æ—Å–∫–æ–ø–æ–º
    request = requests.get("https://horo.mail.ru/prediction/" + day + "/")
    # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç, –ø–∞—Ä—Å–∏–º
    soup = bs4.BeautifulSoup(request.text, "html.parser")
    # –î–æ—Å—Ç–∞—ë–º –Ω—É–∂–Ω—ã–π –Ω–∞–º —Ç–µ–∫—Å—Ç
    horoscope_txt = soup.find('div', 'article__item article__item_alignment_left article__item_html').getText()
    return horoscope_txt


def _personal_command(event):
    """
    –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π.
    :param event —Å–æ–±—ã—Ç–∏–µ
    :return —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –≥–æ—Ä–æ—Å–∫–æ–ø–æ–º
    """
    # –°–ø—Ä–æ—Å–∏—Ç—å –æ —Ç–æ–º, –¥–ª—è –∫–∞–∫–æ–≥–æ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞ –∏—Å–∫–∞—Ç—å –∏–Ω—Ñ–æ
    write_msg(event.user_id, "–ù–∞—Å—á—ë—Ç –∫–∞–∫–æ–≥–æ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–≤—ë–∑–¥—ã?")
    # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
    for event in longpoll.listen():
        # –°—á–∏—Ç—ã–≤–∞–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç–∏–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if event.type == VkEventType.MESSAGE_NEW:
            if event.to_me:
                # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª –∫–æ–º–∞–Ω–¥—É "—Å—Ç–æ–ø"
                if event.text.lower() == "—Å—Ç–æ–ø":
                    _stop_command(event)
                    # –ë–æ—Ç –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ —Ü–∏–∫–ª–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∏ –≥–æ—Ç–æ–≤ –∏—Å–ø–æ–ª–Ω—è—Ç—å –¥—Ä—É–≥–∏–µ –∫–æ–º–∞–Ω–¥—ã
                    break
                # –ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥—ã "/—Å—Ç–æ–ø" –Ω–µ –±—ã–ª–æ
                else:
                    # –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –ó–ó
                    sign = switch_sings(event.text.lower())
                    # –°–ª–æ–≤–∏—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–≤–æ–¥. –ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏—Ç—å –∏ —Å–ª—É—à–∞—Ç—å –¥–∞–ª—å—à–µ
                    if sign == -1:
                        write_msg(event.user_id, "–¢–∞–∫–æ–≥–æ –∑–Ω–∞–∫–∞ —è –Ω–µ –∑–Ω–∞—é... –ü–æ–ø—Ä–æ–±—É–π –≤–≤–µ—Å—Ç–∏ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ "
                                                 "–Ω–∞–ø–∏—à–∏ —Å—Ç–æ–ø, –µ—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –±–æ–ª—å—à–µ –∏—Å–∫–∞—Ç—å –≥–æ—Ä–æ—Å–∫–æ–ø—ã.")
                    # –ï—Å–ª–∏ –≤—Å—ë –≤–≤–µ–¥–µ–Ω–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
                    else:
                        # –í—ã–∑–≤–∞—Ç—å –º–µ—Ç–æ–¥ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –≥–æ—Ä–æ—Å–∫–æ–ø–∞ –ø–æ –∑–Ω–∞–∫—É –∑–æ–¥–∏–∞–∫–∞, –≤–µ—Ä–Ω—É–≤—à–∏–µ—Å—è –¥–∞–Ω–Ω—ã–µ –≤—ã–≤–µ—Å—Ç–∏
                        write_msg(event.user_id, _get_personal_horoscope(sign, event.text.lower()))
                        write_msg(event.user_id, "–ù–∞—Å—á—ë—Ç –∫–∞–∫–æ–≥–æ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–≤—ë–∑–¥—ã?\n"
                                                 "–í–≤–µ–¥–∏ —Å—Ç–æ–ø, –µ—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –±–æ–ª—å—à–µ –∏—Å–∫–∞—Ç—å –≥–æ—Ä–æ—Å–∫–æ–ø—ã "
                                                 "–¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–Ω–∞–∫–∞.")


def _stop_command(event):
    """–§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã —Å—Ç–æ–ø"""
    write_msg(event.user_id, "–•–æ—Ä–æ—à–æ, –±–æ–ª—å—à–µ –Ω–∏–∫–∞–∫–∏—Ö –≥–æ—Ä–æ—Å–∫–æ–ø–æ–≤. "
                             "–ù–æ —è –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–µ! "
                             "–í–≤–µ–¥–∏ /–∫–æ–º–∞–Ω–¥—ã, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥.")


def _show_commands(event):
    """–§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥—ã –∫–æ–º–∞–Ω–¥—ã"""
    write_msg(event.user_id, "–í–æ—Ç —Å–ø–∏—Å–æ–∫ –º–æ–∏—Ö –∫–æ–º–∞–Ω–¥:\n" + bot.read_command_file())


# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥
# –¢—É—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–∞–∫–æ–π-–ª–∏–±–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ —á–∞—Ç–µ
for event in longpoll.listen():
    # –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if event.type == VkEventType.MESSAGE_NEW:
        # –ï—Å–ª–∏ –æ–Ω–æ –¥–ª—è –±–æ—Ç–∞
        if event.to_me:
            # –î–ª—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
            print('New message:')
            print(f'For me by: {event.user_id}', end='' + "\n")

            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —á–∞—Å—Ç—å –±–æ—Ç–∞ –∏–∑ zodiacusBrains.py –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä–≤–∏—á–Ω—ã—Ö –∏ —Å–∞–º—ã—Ö –ª—ë–≥–∫–∏—Ö –∫–æ–º–∞–Ω–¥
            bot = VkBot(event.user_id)

            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥

            # –ï—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ "/–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π"
            if event.text == "–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π":
                _personal_command(event)
            # –ï—Å–ª–∏ –ø–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥
            elif event.text.lower() == "–∫–æ–º–∞–Ω–¥—ã":
                _show_commands(event)
            # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –≤—Å–µ—Ö –∑–Ω–∞–∫–æ–≤ –Ω–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å
            elif event.text.lower() == "—Å–µ–≥–æ–¥–Ω—è":
                write_msg(event.user_id, "–í–æ—Ç —á—Ç–æ –∑–≤—ë–∑–¥—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª–∏ –¥–ª—è –≤—Å–µ—Ö –∑–Ω–∞–∫–æ–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è:\n" \
                          + _get_horoscope_for_all("today"))
            # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å–∏–ª–∏ –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –≤—Å–µ—Ö –∑–Ω–∞–∫–æ–≤ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
            elif event.text.lower() == "–∑–∞–≤—Ç—Ä–∞":
                write_msg(event.user_id, "–í–æ—Ç —á—Ç–æ –∑–≤—ë–∑–¥—ã –≥–æ–≤–æ—Ä—è—Ç –¥–ª—è –≤—Å–µ—Ö –∑–Ω–∞–∫–æ–≤ –Ω–∞ –∑–∞–≤—Ç—Ä–∞:\n" \
                          + _get_horoscope_for_all("tomorrow"))
            else:
                # –ü–æ–ª—É—á–∞–µ–º id —é–∑–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –µ–º—É;
                write_msg(event.user_id, bot.new_message(event.text))

            # –î–ª—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
            print('Text: ', event.text)
