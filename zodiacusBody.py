import bs4
import requests
import vk_api
from vk_api.longpoll import VkLongPoll, VkEventType
from zodiacusBrains import VkBot

# API —Ç–æ–∫–µ–Ω —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
mytoken = 'b8bfa52f5f8b7f2f5d9c787032a5d4b9aac5f9f06e82b3b736ce3a5315cb6bcccb1a725805a2ec024147c'

# –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –∫–∞–∫ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
vk = vk_api.VkApi(token=mytoken)
longpoll = VkLongPoll(vk)


# –§—É–Ω–∫—Ü–∏—è –ø–æ—Å—ã–ª–∞—é—â–∞—è —Å–æ–æ–±—â–µ–Ω–∏–µ
# –ü–æ–ª—É—á–∞–µ—Ç –Ω–∞ –≤—Ö–æ–¥ id —é–∑–µ—Ä–∞, –∫–æ—Ç–æ—Ä–æ–º—É –æ—Ç–ø—Ä–∞–≤–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏ —Å–∞–º–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
def write_msg(user_id, message):
    random_id = vk_api.utils.get_random_id()
    vk.method('messages.send', {'user_id': user_id, 'message': message, 'random_id': random_id})


# –ú–µ—Ç–æ–¥ –≤—ã–±–æ—Ä–∞ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞
def switch_sings(argument):
    return {
        "–æ–≤–µ–Ω": "aries",
        "—Ç–µ–ª–µ—Ü": "taurus",
        "–±–ª–∏–∑–Ω–µ—Ü—ã": "gemini",
        "—Ä–∞–∫": "cancer",
        "–ª–µ–≤": "leo",
        "–¥–µ–≤–∞": "virgo",
        "–≤–µ—Å—ã": "libra",
        "—Å–∫–æ—Ä–ø–∏–æ–Ω": "scorpio",
        "—Å—Ç—Ä–µ–ª–µ—Ü": "sagittarius",
        "–∫–æ–∑–µ—Ä–æ–≥": "capricorn",
        "–≤–æ–¥–æ–ª–µ–π": "aquarius",
        "—Ä—ã–±—ã": "pisces",
    }.get(argument, -1)


# –ú–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –≥–æ—Ä–æ—Å–∫–æ–ø –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞
def _get_pernsonal_horoscope(sign, text):
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –≥–æ—Ä–æ—Å–∫–æ–ø–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–Ω–∞–∫–∞
    request = requests.get("https://horo.mail.ru/prediction/" + sign + "/today/")
    # –ø–∞—Ä—Å–∏–º
    soup = bs4.BeautifulSoup(request.text, "html.parser")
    horoscopeTxt = soup.find('div', 'article__item article__item_alignment_left article__item_html').getText()
    return ("–í–æ—Ç —á—Ç–æ –∑–≤—ë–∑–¥—ã —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–ª–∏ –¥–ª—è –∑–Ω–∞–∫–∞ "+text.lower()+"üëÄ:\n" + horoscopeTxt)


# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
for event in longpoll.listen():  # –¢—É—Ç —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–∞–∫–æ–π-—Ç–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    # –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    if event.type == VkEventType.MESSAGE_NEW:
        # –ï—Å–ª–∏ –æ–Ω–æ –¥–ª—è –±–æ—Ç–∞
        if event.to_me:
            # –î–ª—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
            print('New message:')
            print(f'For me by: {event.user_id}', end='' + "\n")

            bot = VkBot(event.user_id)

            if event.text == "/–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π":
                write_msg(event.user_id, "–ù–∞—Å—á—ë—Ç –∫–∞–∫–æ–≥–æ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–≤—ë–∑–¥—ã?")
                for event in longpoll.listen():
                    if event.type == VkEventType.MESSAGE_NEW:
                        # –ï—Å–ª–∏ –æ–Ω–æ –¥–ª—è –±–æ—Ç–∞
                        if event.to_me:
                            # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª –∫–æ–º–∞–Ω–¥—É "/—Å—Ç–æ–ø"
                            if event.text.lower() == "/—Å—Ç–æ–ø":
                                write_msg(event.user_id, "–•–æ—Ä–æ—à–æ, –±–æ–ª—å—à–µ –Ω–∏–∫–∞–∫–∏—Ö –≥–æ—Ä–æ—Å–∫–æ–ø–æ–≤. "
                                                         "–ù–æ —è –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤ —Å–¥–µ–ª–∞—Ç—å —á—Ç–æ-–Ω–∏–±—É–¥—å –¥—Ä—É–≥–æ–µ! "
                                                         "–í–≤–µ–¥–∏ /–∫–æ–º–∞–Ω–¥—ã, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–∞–Ω–¥.")
                                break  # –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
                            else:
                                # –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ—Ç –≤–≤–µ–¥—ë–Ω–Ω—ã–π –ó–ó —Å –∏–º–µ—é—â–∏–º–∏—Å—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–æ—Ä–æ—Å–∫–æ–ø
                                sign = switch_sings(event.text.lower())
                                if sign == -1:
                                    write_msg(event.user_id, "–ï—â—ë —Ä–∞–∑ —Ç–∞–∫ —Å–¥–µ–ª–∞–µ—à—å - –ø–æ IP –≤—ã—á–∏—Å–ª—é. –¢–µ–±—è –ø–æ–ø—Ä–æ—Å–∏–ª–∏ –∑–Ω–∞–∫ –≤–≤–µ—Å—Ç–∏\n"
                                                             "–ù–∞–ø–∏—à–∏ /—Å—Ç–æ–ø, –µ—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –±–æ–ª—å—à–µ –Ω–∞–ø—Ä—è–≥–∞—Ç—å—Å—è")
                                else:
                                    # –í–µ—Ä–Ω—É–≤—à–µ–µ—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –≤—ã–≤–æ–¥–∏–º –≤ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                                    write_msg(event.user_id, _get_pernsonal_horoscope(sign, event.text.lower()))
                                    write_msg(event.user_id, "–ù–∞—Å—á—ë—Ç –∫–∞–∫–æ–≥–æ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞ —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –∑–≤—ë–∑–¥—ã?\n"
                                                             "–í–≤–µ–¥–∏ /—Å—Ç–æ–ø, –µ—Å–ª–∏ –Ω–µ —Ö–æ—á–µ—à—å –±–æ–ª—å—à–µ –∏—Å–∫–∞—Ç—å –≥–æ—Ä–æ—Å–∫–æ–ø—ã"
                                                             " –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–Ω–∞–∫–∞.")
            elif event.text == "/–∫–æ–º–∞–Ω–¥—ã":
                write_msg(event.user_id, "–í–æ—Ç —Å–ø–∏—Å–æ–∫ –º–æ–∏—Ö –∫–æ–º–∞–Ω–¥:\n" \
                   f"/—Å–µ–≥–æ–¥–Ω—è - –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –≤—Å–µ—Ö –∑–Ω–∞–∫–æ–≤ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è;\n" \
                   f"/–∑–∞–≤—Ç—Ä–∞ - –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –≤—Å–µ—Ö –∑–Ω–∞–∫–æ–≤ –Ω–∞ –∑–∞–≤—Ç—Ä–∞;\n" \
                   f"/–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π - –≥–æ—Ä–æ—Å–∫–æ–ø –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∑–Ω–∞–∫–∞ –∑–æ–¥–∏–∞–∫–∞.")
            else:
                # –ü–æ–ª—É—á–∞–µ–º id —é–∑–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –µ–º—É;
                write_msg(event.user_id, bot.new_message(event.text))

            # –î–ª—è –≤—ã–≤–æ–¥–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
            print('Text: ', event.text)
